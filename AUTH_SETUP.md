# Authentication Setup Guide

Personal Finance app uses Better Auth with Convex adapter. OAuth (Google/GitHub) and Passkeys supported. Email-gated via `ALLOWED_EMAILS` Convex env var.

## What's Implemented

- **Better Auth** with Convex adapter (`@convex-dev/better-auth`)
- **OAuth** - Google and GitHub sign-in
- **Passkeys** - WebAuthn passwordless authentication
- **Email Restriction** - Only `ALLOWED_EMAILS` can access
- **Route Protection** - All routes protected except `/login` and `/api/auth/*`
- **All auth data in Convex** - Users, sessions, accounts, passkeys, verification

## Architecture

```
User visits page
       ↓
proxy.ts checks session cookie (better-auth.session_token)
       ├─ No session? → Redirect to /login
       └─ Has session? → Render page ✅

OAuth Flow:
/login → Click "Sign in with Google/GitHub"
       ↓
/api/auth/[...all] proxies to Convex
       ↓
Convex handles OAuth → databaseHooks validates email
       ↓
Success: Set session cookie, redirect to app
Failure: "Email not authorized" error
```

## Environment Variables

### Convex Environment (set via `npx convex env set`)

```bash
# Auth secret (required)
npx convex env set BETTER_AUTH_SECRET=$(openssl rand -base64 32)

# Your app URL
npx convex env set SITE_URL http://localhost:3000

# Allowed emails (comma-separated)
npx convex env set ALLOWED_EMAILS "your-email@gmail.com"

# Google OAuth
npx convex env set GOOGLE_CLIENT_ID "your-google-client-id"
npx convex env set GOOGLE_CLIENT_SECRET "your-google-client-secret"

# GitHub OAuth
npx convex env set GITHUB_CLIENT_ID "your-github-client-id"
npx convex env set GITHUB_CLIENT_SECRET "your-github-client-secret"
```

### Local Environment (.env.local)

```bash
# Convex (auto-generated by npx convex dev)
CONVEX_DEPLOYMENT=dev:adjective-animal-123
NEXT_PUBLIC_CONVEX_URL=https://adjective-animal-123.convex.cloud
NEXT_PUBLIC_CONVEX_SITE_URL=https://adjective-animal-123.convex.site
```

## Setup Steps

### 1. Generate Auth Secret

```bash
npx convex env set BETTER_AUTH_SECRET=$(openssl rand -base64 32)
```

### 2. Set Site URL

```bash
npx convex env set SITE_URL http://localhost:3000
```

### 3. Set Allowed Emails

```bash
npx convex env set ALLOWED_EMAILS "yourname@gmail.com"
```

Email must match your Google/GitHub OAuth account.

### 4. Set Up Google OAuth

1. Go to [Google Cloud Console](https://console.cloud.google.com/apis/credentials)
2. Create OAuth 2.0 Client ID
3. Add redirect URI: `http://localhost:3000/api/auth/callback/google`
4. Set env vars:
   ```bash
   npx convex env set GOOGLE_CLIENT_ID "your-client-id"
   npx convex env set GOOGLE_CLIENT_SECRET "your-client-secret"
   ```

### 5. Set Up GitHub OAuth

1. Go to [GitHub Developer Settings](https://github.com/settings/developers)
2. Create OAuth App
3. Set callback URL: `http://localhost:3000/api/auth/callback/github`
4. Set env vars:
   ```bash
   npx convex env set GITHUB_CLIENT_ID "your-client-id"
   npx convex env set GITHUB_CLIENT_SECRET "your-client-secret"
   ```

## Key Files

### Convex Auth Files

- `convex/auth.ts` - Better Auth instance with Convex adapter, OAuth + Passkey config
- `convex/auth.config.ts` - Auth config provider
- `convex/convex.config.ts` - Registers Better Auth component
- `convex/http.ts` - HTTP routes for auth endpoints

### Next.js Auth Files

- `src/lib/auth/auth-client.ts` - Client-side auth (signIn, signOut, useSession)
- `src/lib/auth/auth-server.ts` - Server utilities (getSession)
- `src/app/api/auth/[...all]/route.ts` - Proxies auth requests to Convex
- `src/proxy.ts` - Route protection (session cookie check)

### UI Components

- `src/app/login/page.tsx` - Login page
- `src/components/LoginButtons.tsx` - OAuth buttons
- `src/components/LogoutButton.tsx` - Sign out button
- `src/app/(app)/settings/security/page.tsx` - Passkey management

## Testing

1. Start Convex dev server:
   ```bash
   npx convex dev
   ```

2. Build and start Next.js:
   ```bash
   npm run build && npm start
   ```

3. Navigate to `http://localhost:3000`
   - Redirected to `/login`

4. Sign in with Google or GitHub
   - If email matches `ALLOWED_EMAILS` → Dashboard
   - If not → "Email not authorized" error

## How Security Works

### Route Protection (proxy.ts)

- Checks `better-auth.session_token` cookie on every request
- No session → redirect to `/login`
- Public routes: `/login`, `/api/auth/*`, static files

### Email Validation (Convex databaseHooks)

- Runs when user is created via OAuth
- Checks if email is in `ALLOWED_EMAILS`
- Denies access if email not allowed

```typescript
// convex/auth.ts
databaseHooks: {
  user: {
    create: {
      before: async (user) => {
        if (!isEmailAllowed(user.email)) {
          throw new Error("Email not authorized")
        }
        return { data: user }
      },
    },
  },
},
```

## Production Deployment

1. Set production env vars in Convex:
   ```bash
   npx convex env set SITE_URL https://yourdomain.com
   ```

2. Add production OAuth callback URLs:
   - Google: `https://yourdomain.com/api/auth/callback/google`
   - GitHub: `https://yourdomain.com/api/auth/callback/github`

3. Deploy Convex:
   ```bash
   npx convex deploy
   ```

4. Set `NEXT_PUBLIC_CONVEX_SITE_URL` in production env

## Passkeys

Passkey (WebAuthn) support is built-in.

### Register Passkey

1. Login via OAuth first
2. Go to Settings → Security
3. Click "Add Passkey"
4. Follow browser prompts

### Login with Passkey

1. Go to `/login`
2. Click "Sign in with Passkey"
3. Authenticate via device

## Troubleshooting

### "Email not authorized" error
- Check `ALLOWED_EMAILS` in Convex env
- Verify email matches OAuth account (case-insensitive)

### Redirect loops
- Clear cookies
- Verify `SITE_URL` matches app URL
- Check OAuth callback URLs

### OAuth errors
- Verify Client ID/Secret in Convex env
- Check redirect URIs match exactly
- Check Convex logs: `npx convex dashboard`

### Session issues
- Clear cookies
- Re-generate `BETTER_AUTH_SECRET` (logs out all users)
- Restart Convex dev server

## Multiple Allowed Emails

Comma-separated in env var:

```bash
npx convex env set ALLOWED_EMAILS "email1@gmail.com,email2@gmail.com"
```

## Documentation

- [Better Auth](https://better-auth.com)
- [@convex-dev/better-auth](https://www.npmjs.com/package/@convex-dev/better-auth)
- [Convex](https://docs.convex.dev)
- [Next.js 16](https://nextjs.org/docs)
